<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Leaderboard — EuroFantasy</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* === LEADERBOARD PAGE === */
    .leaderboard-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    .leaderboard-page h1 {
      font-family: 'Petrov Sans', sans-serif;
      font-size: 2.2rem;
      margin-bottom: 1rem;
      text-align: center;
      color: var(--yellow);
      letter-spacing: 1px;
    }
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2a2a;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
    }
    .leaderboard-table thead {
      background: var(--purple);
    }
    .leaderboard-table th, .leaderboard-table td {
      padding: 0.8rem 1rem;
      text-align: left;
      font-size: 0.95rem;
      color: var(--white);
    }
    .leaderboard-table th { font-weight: bold; text-transform: uppercase; }
    .leaderboard-table tr:nth-child(even) { background: #222; }
    .leaderboard-table tr:hover { background: rgba(254,100,28,0.15); transition: 0.2s; }
    .leaderboard-table tr.me { background: rgba(253,230,0,0.25); font-weight: bold; }

    .roster-panel {
      margin-top: 2rem;
      background: #2a2a2a;
      border-radius: 16px;
      padding: 1.5rem;
      max-height: var(--panel-max-height);
      overflow-y: auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
    }
    .roster-panel h2 { color: var(--orange); font-size: 1.6rem; margin-bottom: 1rem; }
    .roster-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
    .roster-card {
      background: #1c1c1c;
      border-radius: 12px;
      padding: 0.8rem;
      text-align: center;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }
    .roster-card img { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem; }
    .roster-card .name { font-size: 0.9rem; font-weight: bold; margin-bottom: 0.3rem; }
    .roster-card .club { font-size: 0.8rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="leaderboard-page">
    <h1>Турнирная таблица</h1>
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Команда</th>
          <th>Очки</th>
          <th>Состав</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>

    <div class="roster-panel hidden" id="roster-panel">
      <h2>Состав команды</h2>
      <div class="roster-list" id="roster-list"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    const supabase = window.supabase.createClient(
      "https://xovxokupvsnnjtskdgvr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvdnhva3VwdnNubmp0c2tkZ3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDk4NjMsImV4cCI6MjA3MDQyNTg2M30.Vl5Z9DABFmHQWGtfbyuAZGGgfX4hDYGAPD8C7fr540E"
    );

    let currentUser = null;

    async function getCurrentUser() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
    }
  async function getPlayerStats(playerIds, tour = 1) {
    const { data, error } = await supabase
      .from('player_stats')
      .select('*')
      .in('player_id', playerIds)
      .eq('tour', tour);
  
    if (error) {
      console.error('Ошибка при запросе player_stats:', error);
      return [];
    }
  
    // Возвращаем stats по player_id
    const statsMap = {};
    data.forEach(s => {
      statsMap[s.player_id] = s;
    });
    return statsMap;
  }
  
  async function calculateTeamPoints(teamId, currentTour = 1) {
    // 1. Получаем игроков команды вместе с их ролью
    const { data: teamPlayers, error: tpError } = await supabase
      .from('team_players')
      .select('player_id, role_id (formula)')
      .eq('team_id', teamId);
  
    if (tpError) {
      console.error('Ошибка при запросе team_players:', tpError);
      return 0;
    }
  
    if (!teamPlayers || teamPlayers.length === 0) {
      console.warn(`Команда ${teamId} не содержит игроков`);
      return 0;
    }
  
    const playerIds = teamPlayers.map(p => p.player_id);
  
    // 2. Получаем статистику игроков из player_stats
    const { data: statsData, error: statsError } = await supabase
      .from('player_stats')
      .select('*')
      .in('player_id', playerIds)
      .eq('tour', currentTour);
  
    if (statsError) {
      console.error('Ошибка при запросе player_stats:', statsError);
      return 0;
    }
  
    // 3. Создаём карту player_id → stats
    const statsMap = {};
    statsData.forEach(s => statsMap[s.player_id] = s);
  
    let total = 0;
  
    // 4. Вычисляем очки каждого игрока по формуле роли
    teamPlayers.forEach((p, index) => {
      const stats = statsMap[p.player_id] || {};
      const formula = p.role_id?.formula;
  
      console.group(`Игрок #${index + 1}`);
      console.log('Stats:', stats);
      console.log('Formula:', formula);
  
      if (!formula) {
        console.warn('Формула роли не задана, пропускаем игрока');
        console.groupEnd();
        return;
      }
  
      const context = {
        points: stats.points || 0,
        assists: stats.assists || 0,
        rebounds: stats.rebounds || 0,
        steals: stats.steals || 0,
        blocks: stats.blocks || 0,
        turnover: stats.turnover || 0,
        threes: stats.threes || 0,
        count: stats.count || 1
      };
  
      console.log('Context для формулы:', context);
  
      try {
        const fn = new Function(...Object.keys(context), `return (${formula});`);
        const result = fn(...Object.values(context));
        console.log('Результат формулы:', result);
        total += isNaN(result) ? 0 : result;
      } catch (e) {
        console.error('Ошибка при вычислении формулы:', formula, e);
      }
  
      console.groupEnd();
    });
  
    console.log(`Total очки команды ${teamId}:`, total);
    return Math.round(total);
  }


    async function loadLeaderboard() {
      const { data: teams, error } = await supabase.from('user_teams').select('id, team_name, user_id');
      if (error) { console.error('Ошибка загрузки команд:', error); return; }

      const leaderboardBody = document.getElementById('leaderboard-body');
      leaderboardBody.innerHTML = '';

      for (const team of teams) {
        const totalPoints = await calculateTeamPoints(team.id);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${team.team_name}</td>
          <td>${totalPoints}</td>
          <td><button class="show-lineup" data-team-id="${team.id}">Состав</button></td>
        `;
        leaderboardBody.appendChild(row);
      }

      document.querySelectorAll('.show-lineup').forEach(btn => {
        btn.addEventListener('click', async e => {
          const teamId = e.target.dataset.teamId;
          await showRoster(teamId);
        });
      });
    }

    async function showRoster(teamId, currentTour = 1) {
  // 1. Получаем игроков команды вместе со статистикой за тур
  const { data: teamPlayers, error: tpError } = await supabase
    .from('team_players')
    .select('player_id, role_id (formula)')
    .eq('team_id', teamId);

  if (tpError) {
    console.error('Ошибка showRoster team_players:', tpError);
    return;
  }

  if (!teamPlayers || teamPlayers.length === 0) {
    console.warn(`Команда ${teamId} не содержит игроков`);
    return;
  }

  const playerIds = teamPlayers.map(p => p.player_id);

  const { data: statsData, error: statsError } = await supabase
    .from('player_stats')
    .select('*')
    .in('player_id', playerIds)
    .eq('tour', currentTour);

  if (statsError) {
    console.error('Ошибка showRoster player_stats:', statsError);
    return;
  }

  const statsMap = {};
  statsData.forEach(s => statsMap[s.player_id] = s);

  // 2. Получаем данные игроков (имя, фото и т.д.)
  const { data: playersData, error: playersError } = await supabase
    .from('players')
    .select('*')
    .in('id', playerIds);

  if (playersError) {
    console.error('Ошибка showRoster players:', playersError);
    return;
  }

  const playersMap = {};
  playersData.forEach(p => playersMap[p.id] = p);

  // 3. Рисуем панель состава
  const panel = document.getElementById('roster-panel');
  const list = document.getElementById('roster-list');
  list.innerHTML = '';

  teamPlayers.forEach(p => {
    const stats = statsMap[p.player_id] || {};
    const formula = p.role_id?.formula;
    const player = playersMap[p.player_id];

    if (!player) return;

    // Вычисляем очки по формуле роли
    let points = 0;
    if (formula) {
      const context = {
        points: stats.points || 0,
        assists: stats.assists || 0,
        rebounds: stats.rebounds || 0,
        steals: stats.steals || 0,
        blocks: stats.blocks || 0,
        turnover: stats.turnover || 0,
        threes: stats.threes || 0,
        count: stats.count || 1
      };

      try {
        const fn = new Function(...Object.keys(context), `return (${formula});`);
        points = isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
      } catch (e) {
        console.error('Ошибка расчёта очков для игрока', player.first_name, player.last_name, e);
      }
    }

    const card = document.createElement('div');
    card.className = 'roster-card';
    card.innerHTML = `
      <img src="${player.photo_url || 'image/ball.svg'}" alt="">
      <div class="name">${player.first_name} ${player.last_name}</div>
      <div class="points">Очки: ${Math.round(points)}</div>
      <div class="club">${player.country}</div>
      <div class="position">${player.position}</div>
    `;
    list.appendChild(card);
  });

  panel.classList.remove('hidden');
}


    (async () => {
      await getCurrentUser();
      await loadLeaderboard();
    })();
  </script>
</body>
</html>




