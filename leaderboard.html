<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard — EuroFantasy</title>
<style>
  /* === LEADERBOARD PAGE === */
  .leaderboard-page { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
  .leaderboard-page h1 { font-family: 'Petrov Sans', sans-serif; font-size: 2.2rem; margin-bottom: 1rem; text-align:center; color:var(--yellow); }
/* === LEADERBOARD TABLE === */
/* === LEADERBOARD TABLE === */
.leaderboard-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 0 25px rgba(0,0,0,0.5);
  background: #2a2a2a;
}

.leaderboard-table thead {
  background: var(--purple);
}

.leaderboard-table th {
  padding: 0.8rem 1rem;
  text-align: left;
  font-weight: bold;
  font-size: 1rem;
  color: var(--white);
  text-transform: uppercase;
}

.leaderboard-table td {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid #444;
  font-size: 0.95rem;
  color: var(--white);
}

.leaderboard-table tr:nth-child(even) {
  background: #222;
}

.leaderboard-table tr:hover {
  background: rgba(254,100,28,0.15);
  transition: background 0.2s ease-in-out;
}

.leaderboard-table tr.me {
  background: rgba(253,230,0,0.25);
  font-weight: bold;
}

/* Кнопка "Состав" в стиле дашборда */
.leaderboard-table .show-lineup {
  padding: 6px 12px;
  border-radius: 12px;
  background: var(--orange);
  color: var(--white);
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.12s ease, opacity 0.12s ease;
  border: none;
}

.leaderboard-table .show-lineup:hover {
  transform: translateY(-2px);
  opacity: 0.95;
}

/* Итоговая колонка (Total points) выделена */
.leaderboard-table td.total {
  font-weight: bold;
  color: var(--yellow);
}


  .roster-panel { margin-top:2rem; background:#2a2a2a; border-radius:16px; padding:1.5rem; max-height:500px; overflow-y:auto; box-shadow:0 0 15px rgba(0,0,0,0.4);}
  .roster-panel h2 { color:orange; font-size:1.6rem; margin-bottom:1rem; }
  .roster-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:1rem; }
  .roster-card { background:#1c1c1c; border-radius:12px; padding:0.8rem; text-align:center; box-shadow:0 0 8px rgba(0,0,0,0.4);}
  .roster-card img { width:64px; height:64px; border-radius:50%; object-fit:cover; margin-bottom:0.5rem; }
  .roster-card .name { font-size:0.9rem; font-weight:bold; margin-bottom:0.3rem; }
  .roster-card .club { font-size:0.8rem; color:#aaa; }
  .roster-card .points { font-size:0.85rem; color:yellow; margin-bottom:0.3rem; }
</style>
</head>
<body>
<div class="leaderboard-page">
  <h1>Турнирная таблица</h1>
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>Команда</th>
        <th>Тур 1</th>
        <th>Тур 2-3</th>
        <th>Тур 4</th>
        <th>Тур 5</th>
        <th>1/8</th>
        <th>1/4</th>
        <th>1/2</th>
        <th>Финалы</th>
        <th>Итого</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <div class="roster-panel hidden" id="roster-panel">
    <h2>Состав команды</h2>
    <div class="roster-list" id="roster-list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
const supabase = window.supabase.createClient(
  "https://xovxokupvsnnjtskdgvr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvdnhva3VwdnNubmp0c2tkZ3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDk4NjMsImV4cCI6MjA3MDQyNTg2M30.Vl5Z9DABFmHQWGtfbyuAZGGgfX4hDYGAPD8C7fr540E"
);

const TOURS = ["1","2-3","4","5","1/8","1/4","1/2","Финалы"];

let currentUser = null;

async function getCurrentUser() {
  const { data: { user } } = await supabase.auth.getUser();
  currentUser = user;
}

async function calculateTeamPoints(teamId, currentTour = 1) {
  const { data: teamPlayers, error: tpError } = await supabase
    .from('team_players')
    .select('player_id, role_id (formula)')
    .eq('team_id', teamId);
  if (tpError) return 0;

  if (!teamPlayers || teamPlayers.length === 0) return 0;

  const playerIds = teamPlayers.map(p => p.player_id);

  const { data: statsData } = await supabase
    .from('player_stats')
    .select('*')
    .in('player_id', playerIds)
    .eq('tour', currentTour);

  const statsMap = {};
  (statsData||[]).forEach(s => statsMap[s.player_id]=s);

  let total=0;
  teamPlayers.forEach(p=>{
    const stats=statsMap[p.player_id]||{};
    const formula=p.role_id?.formula;
    if (!formula) return;

    const context = {
      points: stats.points||0,
      assists: stats.assists||0,
      rebounds: stats.rebounds||0,
      steals: stats.steals||0,
      blocks: stats.blocks||0,
      turnover: stats.turnover||0,
      threes: stats.threes||0,
      count: stats.count||1
    };
    try{
      const fn=new Function(...Object.keys(context),`return (${formula});`);
      total += isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
    }catch(e){console.error('Ошибка расчёта формулы:',formula,e);}
  });
  return Math.round(total);
}

async function loadLeaderboard() {
  const { data: teams } = await supabase.from('user_teams').select('id, team_name');
  const tbody = document.getElementById('leaderboard-body');
  tbody.innerHTML='';

  for(const team of teams){
    const row=document.createElement('tr');
    let totalSum=0;
    row.innerHTML=`<td>${team.team_name}</td>`;

    for(const tour of TOURS){
      const tourNumbers = tour.includes("-") ? tour.split("-").map(Number) : [tour=="Финалы"?99:Number(tour)];
      let points=0;
      for(const t of tourNumbers) points += await calculateTeamPoints(team.id, t);
      totalSum += points;

      const cell=document.createElement('td');
      cell.innerHTML = `${points} <button class="show-lineup" data-team-id="${team.id}" data-tour="${tour}">Состав</button>`;
      row.appendChild(cell);
    }

    const totalCell=document.createElement('td');
    totalCell.innerText=totalSum;
    row.appendChild(totalCell);

    tbody.appendChild(row);
  }

  document.querySelectorAll('.show-lineup').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      const teamId=e.target.dataset.teamId;
      const tour=e.target.dataset.tour;
      await showRoster(teamId, tour.includes("-") ? parseInt(tour.split("-")[0]) : tour=="Финалы"?99:parseInt(tour));
    });
  });
}

async function showRoster(teamId, currentTour=1){
  const { data: teamPlayers } = await supabase
    .from('team_players')
    .select('player_id, role_id (formula)')
    .eq('team_id', teamId);

  if(!teamPlayers) return;

  const playerIds = teamPlayers.map(p=>p.player_id);

  const { data: statsData } = await supabase
    .from('player_stats')
    .select('*')
    .in('player_id', playerIds)
    .eq('tour', currentTour);

  const statsMap = {};
  (statsData||[]).forEach(s=>statsMap[s.player_id]=s);

  const { data: playersData } = await supabase
    .from('players')
    .select('*')
    .in('id', playerIds);

  const playersMap = {};
  (playersData||[]).forEach(p=>playersMap[p.id]=p);

  const panel = document.getElementById('roster-panel');
  const list = document.getElementById('roster-list');
  list.innerHTML='';

  teamPlayers.forEach(p=>{
    const stats=statsMap[p.player_id]||{};
    const formula=p.role_id?.formula;
    const player=playersMap[p.player_id];
    if(!player) return;

    let points=0;
    if(formula){
      const context = {
        points: stats.points||0,
        assists: stats.assists||0,
        rebounds: stats.rebounds||0,
        steals: stats.steals||0,
        blocks: stats.blocks||0,
        turnover: stats.turnover||0,
        threes: stats.threes||0,
        count: stats.count||1
      };
      try{
        const fn=new Function(...Object.keys(context),`return (${formula});`);
        points=isNaN(fn(...Object.values(context)))?0:fn(...Object.values(context));
      }catch(e){console.error('Ошибка расчёта очков игрока',player.first_name,player.last_name,e);}
    }

    const card=document.createElement('div');
    card.className='roster-card';
    card.innerHTML=`
      <img src="${player.photo_url||'image/ball.svg'}" alt="">
      <div class="name">${player.first_name} ${player.last_name}</div>
      <div class="points">Очки: ${Math.round(points)}</div>
      <div class="club">${player.country}</div>
      <div class="position">${player.position}</div>
    `;
    list.appendChild(card);
  });

  panel.classList.remove('hidden');
}

(async()=>{ await getCurrentUser(); await loadLeaderboard(); })();
</script>
</body>
</html>


