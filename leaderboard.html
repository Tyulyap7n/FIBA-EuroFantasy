<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Leaderboard — EuroFantasy</title>
  <link rel="shortcut icon" href="image/img.jpg" type="image/jpg">
  <style>
    :root {
      --purple: #633EDC;
      --orange: #FE641C;
      --yellow: #FDE600;
      --black: #1c1c1c;
      --white: #ffffff;
      --muted: #bfbfbf;
      --panel-max-height: 1600px;
    }

    @font-face {
      font-family: 'Petrov Sans';
      src: url('/fonts/PetrovSans-Trial-Bold.otf') format('opentype');
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    body {
      margin: 0;
      background: var(--black);
      color: var(--white);
      font-family: 'Petrov Sans', Inter, system-ui, sans-serif;
      font-size: 20px;
      line-height: 1.2;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--purple);
      padding: 10px 20px;
      border-bottom: 4px solid var(--yellow);
    }

    .site-header img.logo {
      height: 50px;
      display: block;
    }

    .header-links {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .header-link {
      color: var(--white);
      text-decoration: none;
      font-weight: 700;
    }

    .header-link:hover {
      color: var(--yellow);
    }

    .cell-class {
      color: black;
    }

    .show-lineup {
      background-color: var(--yellow);
      color: black;
      border: none;
      padding: 3px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .show-lineup:hover {
      opacity: 0.9;
    }

    .custom-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: var(--black);
      border-bottom: 3px solid var(--white);
    }

    .leaderboard-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .leaderboard-page h1 {
      font-family: 'Petrov Sans', sans-serif;
      font-size: 2.2rem;
      margin-bottom: 1rem;
      text-align: center;
      color: var(--yellow);
      letter-spacing: 1px;
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--purple);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
    }

    .leaderboard-table thead {
      background: var(--purple);
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 0.5rem 0.6rem;
      text-align: center;
      font-size: 0.8rem;
      color: var(--white);
      white-space: nowrap;
    }

    .leaderboard-table th {
      font-weight: bold;
      text-transform: uppercase;
    }

    .leaderboard-table tr:nth-child(even) {
      background: #222;
    }

    .leaderboard-table tr:hover {
      background: rgba(254, 100, 28, 0.15);
      transition: 0.2s;
    }

    .leaderboard-table tr.me {
      background: rgba(253, 230, 0, 0.25);
      font-weight: bold;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }

    .pagination button {
      background: var(--purple);
      color: var(--white);
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .pagination button:hover {
      background: var(--yellow);
      color: black;
    }

    .pagination button.active {
      background: var(--orange);
      color: black;
    }

    .roster-panel {
      margin-top: 2rem;
      background: var(--purple);
      border-radius: 16px;
      padding: 1.5rem;
      max-height: var(--panel-max-height);
      overflow-y: auto;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
      display: none;
    }

    .roster-panel h2 {
      color: var(--orange);
      font-size: 1.6rem;
      margin-bottom: 1rem;
    }

    .roster-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }

    .roster-card {
      background: var(--purple);
      border-radius: 12px;
      padding: 0.8rem;
      text-align: center;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
    }

    .roster-card img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.5rem;
    }

    .roster-card .name {
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 0.3rem;
      color: var(--orange);
    }

    .roster-card .role {
      font-size: 0.75rem;
      color: var(--yellow);
      margin-bottom: 0.3rem;
      font-style: italic;
    }

    .roster-card .club {
      font-size: 0.8rem;
      color: var(--orange);
    }

    .roster-card .points {
      font-size: 0.85rem;
      color: var(--orange);
      margin-bottom: 0.3rem;
    }

    a img {
      height: 50px;
      width: auto;
      display: block;
    }

    .hidden {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--yellow);
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="logo-container">
      <a href="dashboard.html">
        <img src="image/logo.jpg" alt="logo">
      </a>
    </div>
  </header>

  <div class="leaderboard-page">
    <h1>LEADERBOARD</h1>
    <div id="loading" class="loading">Загрузка данных...</div>
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>Place</th>
          <th>TEAM</th>
          <th>TOUR 1</th>
          <th>TOUR 2-3</th>
          <th>TOUR 4</th>
          <th>TOUR 5</th>
          <th>1/8</th>
          <th>1/4</th>
          <th>1/2</th>
          <th>FINALS</th>
          <th>SUMMARY</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
    <div class="roster-panel" id="roster-panel">
      <h2>TEAM ROSTER</h2>
      <div class="roster-list" id="roster-list"></div>
      <div id="team-history"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Инициализация Supabase клиента
    const supabaseUrl = "https://xovxokupvsnnjtskdgvr.supabase.co";
    const supabaseKey = "YOUR_SUPABASE_ANON_KEY"; // Замените на реальный ключ или используйте бэкенд-прокси
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Константы
    const TOURS = ["1", "2-3", "4", "5", "1/8", "1/4", "1/2", "Финалы"];
    const ITEMS_PER_PAGE = 15;
    let currentPage = 1;
    let allTeams = [];

    // Функция для отображения индикатора загрузки
    function showLoading(isLoading) {
      const loadingElement = document.getElementById("loading");
      loadingElement.style.display = isLoading ? "block" : "none";
    }

    // Расчёт очков команды
    async function calculateTeamPoints(teamId, currentTour = 1) {
      try {
        const { data: teamPlayers } = await supabase
          .from("team_players")
          .select("player_id, role_id (formula)")
          .eq("team_id", teamId)
          .eq("tour_id", currentTour);

        if (!teamPlayers || teamPlayers.length === 0) return 0;

        const playerIds = teamPlayers.map((p) => p.player_id);
        const { data: statsData } = await supabase
          .from("player_stats")
          .select("*")
          .in("player_id", playerIds)
          .eq("tour", currentTour);

        const statsMap = {};
        (statsData || []).forEach((s) => (statsMap[s.player_id] = s));

        let total = 0;
        teamPlayers.forEach((p) => {
          const stats = statsMap[p.player_id] || {};
          const formula = p.role_id?.formula;
          if (!formula) return;

          const context = { ...stats, count: stats.count || 1 };
          try {
            const fn = new Function(...Object.keys(context), `return (${formula});`);
            total += isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
          } catch (e) {
            console.error("Ошибка формулы:", formula, e);
          }
        });

        return Math.round(total);
      } catch (e) {
        console.error("Ошибка calculateTeamPoints:", e);
        return 0;
      }
    }

    // Загрузка лидерборда
    async function loadLeaderboard() {
      showLoading(true);
      try {
        const { data: teams, error: teamsError } = await supabase
          .from("user_teams")
          .select("id, team_name");

        if (teamsError) throw teamsError;

        const teamPoints = {};
        teams.forEach((team) => {
          teamPoints[team.id] = {
            name: team.team_name,
            tour_1: 0,
            tour_2_3: 0,
            tour_4: 0,
            tour_5: 0,
            tour_6: 0,
            tour_7: 0,
            tour_8: 0,
            tour_finals: 0,
            total: 0,
          };
        });

        const { data: playerStats, error: statsError } = await supabase
          .from("leaderboard_cache")
          .select("*");

        if (statsError) throw statsError;

        const { data: teamPlayers, error: teamPlayersError } = await supabase
          .from("team_players")
          .select("team_id, player_id, tour_id, role_id");

        if (teamPlayersError) throw teamPlayersError;

        for (const team of teams) {
          const teamId = team.id;
          const playersInTeam = teamPlayers.filter((tp) => tp.team_id === teamId);

          for (const player of playersInTeam) {
            const stat = playerStats.find(
              (s) => s.player_id === player.player_id && s.tour_number === player.tour_id
            );
            if (!stat) continue;

            const points = stat.points;
            switch (player.tour_id) {
              case 1:
                teamPoints[teamId].tour_1 += points;
                break;
              case 2:
                teamPoints[teamId].tour_2_3 += points;
                break;
              case 3:
                teamPoints[teamId].tour_2_3 += points;
                break;
              case 4:
                teamPoints[teamId].tour_4 += points;
                break;
              case 5:
                teamPoints[teamId].tour_5 += points;
                break;
              case 6:
                teamPoints[teamId].tour_6 += points;
                break;
              case 7:
                teamPoints[teamId].tour_7 += points;
                break;
              case 8:
                teamPoints[teamId].tour_8 += points;
                break;
              case 99:
                teamPoints[teamId].tour_finals += points;
                break;
            }
          }

          teamPoints[teamId].total =
            teamPoints[teamId].tour_1 +
            teamPoints[teamId].tour_2_3 +
            teamPoints[teamId].tour_4 +
            teamPoints[teamId].tour_5 +
            teamPoints[teamId].tour_6 +
            teamPoints[teamId].tour_7 +
            teamPoints[teamId].tour_8 +
            teamPoints[teamId].tour_finals;
        }

        allTeams = Object.entries(teamPoints)
          .map(([teamId, data]) => ({ teamId, ...data }))
          .sort((a, b) => b.total - a.total);

        renderPage(currentPage);
        renderPagination();
      } catch (e) {
        console.error("Ошибка loadLeaderboard:", e);
      } finally {
        showLoading(false);
      }
    }

    // Отображение страницы
    function renderPage(page) {
      const tbody = document.getElementById("leaderboard-body");
      tbody.innerHTML = "";
      const start = (page - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageTeams = allTeams.slice(start, end);

      for (let i = 0; i < pageTeams.length; i++) {
        const team = pageTeams[i];
        const row = document.createElement("tr");

        const placeCell = document.createElement("td");
        placeCell.innerText = start + i + 1;
        row.appendChild(placeCell);

        const nameCell = document.createElement("td");
        nameCell.innerText = team.name;
        row.appendChild(nameCell);

        const tours = [
          { key: "tour_1", label: "1" },
          { key: "tour_2_3", label: "2-3" },
          { key: "tour_4", label: "4" },
          { key: "tour_5", label: "5" },
          { key: "tour_6", label: "1/8" },
          { key: "tour_7", label: "1/4" },
          { key: "tour_8", label: "1/2" },
          { key: "tour_finals", label: "Финалы" },
        ];

        tours.forEach((tour) => {
          const points = team[tour.key];
          const cell = document.createElement("td");
          cell.innerHTML = `${Math.round(points)} <button class="show-lineup" data-team-id="${
            team.teamId
          }" data-tour="${tour.label}">ROSTER</button>`;
          row.appendChild(cell);
        });

        const totalCell = document.createElement("td");
        totalCell.innerText = Math.round(team.total);
        row.appendChild(totalCell);

        tbody.appendChild(row);
      }

      document.querySelectorAll(".show-lineup").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const teamId = e.target.dataset.teamId;
          const tour = e.target.dataset.tour;
          await showRoster(
            teamId,
            tour.includes("-") ? parseInt(tour.split("-")[0]) : tour === "Финалы" ? 99 : parseInt(tour)
          );
        });
      });
    }

    // Пагинация
    function renderPagination() {
      const paginationEl = document.getElementById("pagination");
      paginationEl.innerHTML = "";
      const pageCount = Math.ceil(allTeams.length / ITEMS_PER_PAGE);

      const prevButton = document.createElement("button");
      prevButton.textContent = "←";
      prevButton.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage(currentPage);
          renderPagination();
        }
      });
      paginationEl.appendChild(prevButton);

      for (let i = 1; i <= pageCount; i++) {
        const pageButton = document.createElement("button");
        pageButton.textContent = i;
        if (i === currentPage) {
          pageButton.classList.add("active");
        }
        pageButton.addEventListener("click", () => {
          currentPage = i;
          renderPage(currentPage);
          renderPagination();
        });
        paginationEl.appendChild(pageButton);
      }

      const nextButton = document.createElement("button");
      nextButton.textContent = "→";
      nextButton.addEventListener("click", () => {
        if (currentPage < pageCount) {
          currentPage++;
          renderPage(currentPage);
          renderPagination();
        }
      });
      paginationEl.appendChild(nextButton);
    }

    // Отображение состава команды
    async function showRoster(teamId, currentTour = 1) {
      try {
        const { data: teamPlayers } = await supabase
          .from("team_players")
          .select("player_id, role_id (id, name, formula)")
          .eq("team_id", teamId)
          .eq("tour_id", currentTour);

        if (!teamPlayers) return;

        const playerIds = teamPlayers.map((p) => p.player_id);
        const { data: statsData } = await supabase
          .from("player_stats")
          .select("*")
          .in("player_id", playerIds)
          .eq("tour", currentTour);

        const statsMap = {};
        (statsData || []).forEach((s) => (statsMap[s.player_id] = s));

        const { data: playersData } = await supabase
          .from("players")
          .select("*")
          .in("id", playerIds);

        const playersMap = {};
        (playersData || []).forEach((p) => (playersMap[p.id] = p));

        const panel = document.getElementById("roster-panel");
        const list = document.getElementById("roster-list");
        list.innerHTML = "";

        teamPlayers.forEach((p) => {
          const stats = statsMap[p.player_id] || {};
          const formula = p.role_id?.formula;
          const player = playersMap[p.player_id];
          if (!player) return;

          let points = 0;
          if (formula) {
            const context = { ...stats, count: stats.count || 1 };
            try {
              const fn = new Function(...Object.keys(context), `return (${formula});`);
              points = isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
            } catch (e) {
              console.error("Ошибка расчёта очков игрока", player.first_name, player.last_name, e);
            }
          }

          const card = document.createElement("div");
          card.className = "roster-card";
          card.innerHTML = `
            <img src="${player.photo_url || "image/ball.svg"}" alt="">
            <div class="role">${p.role_id?.name || "Без роли"}</div>
            <div class="name">${player.first_name} ${player.last_name}</div>
            <div class="club">${player.country}</div>
            <div class="points">Очки: ${Math.round(points)}</div>
          `;
          list.appendChild(card);
        });

        panel.style.display = "block";
      } catch (e) {
        console.error("Ошибка showRoster:", e);
      }
    }

    // Инициализация
    document.addEventListener("DOMContentLoaded", async () => {
      await loadLeaderboard();
    });
  </script>
</body>
</html>
