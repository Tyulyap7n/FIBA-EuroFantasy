<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard — EuroFantasy</title>
<style>
/* === LEADERBOARD PAGE === */
:root{
  --purple: #633EDC;
  --orange: #FE641C;
  --yellow: #FDE600;
  --black: #1c1c1c;
  --white: #ffffff;
  --muted: #bfbfbf;
  --panel-max-height: 1600px;
}

@font-face {
  font-family: 'Petrov Sans';
  src: url('/fonts/PetrovSans-Trial-Bold.otf') format('opentype');
  font-weight: bold;
  font-style: normal;
  font-display: swap;
}
  body{
  margin: 0;
  background: var(--black);
  color: var(--white);
  font-family: 'Petrov Sans', Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  font-size: 20px;
  line-height: 1.2;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
  .site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--purple);
  padding: 10px 20px;
  border-bottom: 4px solid var(--yellow);
}
.site-header img.logo { height: 50px; display:block; }
.header-links { display:flex; gap:20px; align-items:center; }
.header-link { color: var(--white); text-decoration: none; font-weight: 700; }
.header-link:hover { color: var(--yellow); }
/* Черный цвет текста в ячейке */
.cell-class {
  color: black;
}

.show-lineup {
  background-color: var(--yellow);
  color: black; /* Текст кнопки */
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.show-lineup:hover {
  opacity: 0.9;
}

/* Alternative/custom header usage */
.custom-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  background: var(--black);
  border-bottom: 3px solid var(--white);
}
/* Основной контейнер страницы лидерборда */
.leaderboard-page {
  max-width: 1200px; /* Ограничиваем максимальную ширину страницы */
  margin: 0 auto; /* Центрируем блок по горизонтали */
  padding: 2rem 1rem; /* Отступы сверху/снизу 2rem, слева/справа 1rem */
}

/* Заголовок страницы */
.leaderboard-page h1 {
  font-family: 'Petrov Sans', sans-serif; /* Шрифт заголовка */
  font-size: 2.2rem; /* Размер текста заголовка */
  margin-bottom: 1rem; /* Отступ снизу от заголовка */
  text-align: center; /* Выравнивание по центру */
  color: var(--yellow); /* Цвет текста из переменной CSS */
  letter-spacing: 1px; /* Расстояние между буквами */
}

/* Таблица лидерборда */
.leaderboard-table {
  width: 100%; /* Занимает всю ширину контейнера */
  border-collapse: collapse; /* Убирает двойные границы между ячейками */
  background: var(--purple); /* Цвет фона таблицы */
  border-radius: 16px; /* Скругление углов таблицы */
  overflow: hidden; /* Чтобы скругление работало с содержимым */
  box-shadow: 0 0 25px rgba(0,0,0,0.5); /* Тень вокруг таблицы для объёма */
}

/* Шапка таблицы */
.leaderboard-table thead {
  background: var(--purple); /* Фон шапки таблицы */
}

/* Ячейки таблицы (и заголовки, и данные) */
.leaderboard-table th, .leaderboard-table td {
  padding: 0.8rem 1rem; /* Внутренние отступы */
  text-align: left; /* Выравнивание текста слева */
  font-size: 0.95rem; /* Размер текста */
  color: var(--white); /* Цвет текста */
}

/* Только заголовки таблицы */
.leaderboard-table th {
  font-weight: bold; /* Жирный шрифт */
  text-transform: uppercase; /* Преобразование текста в верхний регистр */
}

/* Чередование строк таблицы */
.leaderboard-table tr:nth-child(even) {
  background: #222; /* Тёмный фон для чётных строк */
}

/* Эффект при наведении на строку */
.leaderboard-table tr:hover {
  background: rgba(254,100,28,0.15); /* Полупрозрачный оранжевый фон */
  transition: 0.2s; /* Плавное изменение фона */
}

/* Подсветка строки для "моей" команды */
.leaderboard-table tr.me {
  background: rgba(253,230,0,0.25); /* Полупрозрачный жёлтый фон */
  font-weight: bold; /* Жирный текст */
}

/* Панель состава команды */
.roster-panel {
  margin-top: 2rem; /* Отступ сверху от таблицы */
  background: var(--purple); /* Тёмный фон панели */
  border-radius: 16px; /* Скругление углов */
  padding: 1.5rem; /* Внутренние отступы */
  max-height: var(--panel-max-height); /* Максимальная высота панели */
  overflow-y: auto; /* Прокрутка по вертикали при переполнении */
  box-shadow: 0 0 15px rgba(0,0,0,0.4); /* Тень панели для объёма */
}

/* Заголовок панели состава */
.roster-panel h2 {
  color: var(--orange); /* Оранжевый цвет заголовка */
  font-size: 1.6rem; /* Размер текста */
  margin-bottom: 1rem; /* Отступ снизу */
}

/* Сетка карточек игроков */
.roster-list {
  display: grid; /* Используем grid для сетки */
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Автоматическое распределение колонок */
  gap: 1rem; /* Расстояние между карточками */
}

/* Карточка игрока */
.roster-card {
  background: var(--purple);  /* Тёмный фон */
  border-radius: 12px; /* Скругление углов */
  padding: 0.8rem; /* Внутренние отступы */
  text-align: center; /* Выравнивание содержимого по центру */
  box-shadow: 0 0 8px rgba(0,0,0,0.4); /* Тень карточки */
}

/* Фото игрока */
.roster-card img {
  width: 64px; /* Ширина */
  height: 64px; /* Высота */
  border-radius: 50%; /* Круглая форма */
  object-fit: cover; /* Обрезка по размеру */
  margin-bottom: 0.5rem; /* Отступ снизу */
}

/* Имя игрока */
.roster-card .name {
  font-size: 0.9rem; /* Размер текста */
  font-weight: bold; /* Жирный шрифт */
  margin-bottom: 0.3rem; /* Отступ снизу */
  color: var(--yellow); /* Цвет текста */
}

/* Клуб/страна игрока */
.roster-card .club {
  font-size: 0.8rem; /* Размер текста */
  color: var(--yellow); /* Цвет текста */
}

/* Очки игрока */
.roster-card .points {
  font-size: 0.85rem; /* Размер текста */
  color: var(--yellow); /* Цвет жёлтый, выделяем */
  margin-bottom: 0.3rem; /* Отступ снизу */
}
a img {
  height: 50px;
  width: auto;
  display: block; /* чтобы убрать возможные отступы под изображением */
}  
</style>

</head>
  <script src="script.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    await renderLeaderboard(); 
  });
</script>

<body>
  <header class="site-header">
  <div class="logo-container">
    <a href="dashboard.html"> <img src="image/logo.jpg" alt="logo"></a>
  </div>
</header>
<div class="leaderboard-page">
  <h1>Турнирная таблица</h1>
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>Команда</th>
        <th>Тур 1</th>
        <th>Тур 2-3</th>
        <th>Тур 4</th>
        <th>Тур 5</th>
        <th>1/8</th>
        <th>1/4</th>
        <th>1/2</th>
        <th>Финалы</th>
        <th>Итого</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <div class="roster-panel hidden" id="roster-panel">
    <h2>Состав команды</h2>
    <div class="roster-list" id="roster-list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
const supabase = window.supabase.createClient(
  "https://xovxokupvsnnjtskdgvr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvdnhva3VwdnNubmp0c2tkZ3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDk4NjMsImV4cCI6MjA3MDQyNTg2M30.Vl5Z9DABFmHQWGtfbyuAZGGgfX4hDYGAPD8C7fr540E"
);

const TOURS = ["1","2-3","4","5","1/8","1/4","1/2","Финалы"];

async function calculateTeamPoints(teamId, currentTour = 1) {
  try {
    const { data: teamPlayers } = await supabase
      .from('team_players')
      .select('player_id, role_id (formula)')
      .eq('team_id', teamId);
    if (!teamPlayers || teamPlayers.length === 0) return 0;

    const playerIds = teamPlayers.map(p => p.player_id);
    const { data: statsData } = await supabase
      .from('player_stats')
      .select('*')
      .in('player_id', playerIds)
      .eq('tour', currentTour);

    const statsMap = {};
    (statsData||[]).forEach(s => statsMap[s.player_id]=s);

    let total=0;
    teamPlayers.forEach(p=>{
      const stats=statsMap[p.player_id]||{};
      const formula=p.role_id?.formula;
      if (!formula) return;

      const context = { ...stats, count: stats.count||1 };
      try{
        const fn=new Function(...Object.keys(context),`return (${formula});`);
        total += isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
      }catch(e){console.error('Ошибка формулы:', formula, e);}
    });
    return Math.round(total);
  } catch(e) {
    console.error('Ошибка calculateTeamPoints:', e);
    return 0;
  }
}

async function loadLeaderboard() {
  try {
    const { data: teams } = await supabase.from('user_teams').select('id, team_name');
    const tbody = document.getElementById('leaderboard-body');
    tbody.innerHTML = '';

    for(const team of teams){
      const row = document.createElement('tr');
      let totalSum = 0;
      row.innerHTML = `<td>${team.team_name}</td>`;

      for(const tour of TOURS){
        const tourNumbers = tour.includes("-") ? tour.split("-").map(Number) : [tour=="Финалы"?99:Number(tour)];
        let points = 0;
        for(const t of tourNumbers) points += await calculateTeamPoints(team.id, t);
        totalSum += points;

        const cell = document.createElement('td');
        cell.innerHTML = `${points} <button class="show-lineup" data-team-id="${team.id}" data-tour="${tour}">Состав</button>`;
        row.appendChild(cell);
      }

      const totalCell = document.createElement('td');
      totalCell.innerText = totalSum;
      row.appendChild(totalCell);

      tbody.appendChild(row);
    }

    document.querySelectorAll('.show-lineup').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        const teamId=e.target.dataset.teamId;
        const tour=e.target.dataset.tour;
        await showRoster(teamId, tour.includes("-") ? parseInt(tour.split("-")[0]) : tour=="Финалы"?99:parseInt(tour));
      });
    });
  } catch(e) {
    console.error('Ошибка loadLeaderboard:', e);
  }
}

async function showRoster(teamId, currentTour=1){
  try {
    const { data: teamPlayers } = await supabase
      .from('team_players')
      .select('player_id, role_id (formula)')
      .eq('team_id', teamId);
    if(!teamPlayers) return;

    const playerIds = teamPlayers.map(p=>p.player_id);

    const { data: statsData } = await supabase
      .from('player_stats')
      .select('*')
      .in('player_id', playerIds)
      .eq('tour', currentTour);

    const statsMap = {};
    (statsData||[]).forEach(s=>statsMap[s.player_id]=s);

    const { data: playersData } = await supabase
      .from('players')
      .select('*')
      .in('id', playerIds);

    const playersMap = {};
    (playersData||[]).forEach(p=>playersMap[p.id]=p);

    const panel = document.getElementById('roster-panel');
    const list = document.getElementById('roster-list');
    list.innerHTML='';

    teamPlayers.forEach(p=>{
      const stats=statsMap[p.player_id]||{};
      const formula=p.role_id?.formula;
      const player=playersMap[p.player_id];
      if(!player) return;

      let points=0;
      if(formula){
        const context = { ...stats, count: stats.count||1 };
        try{
          const fn=new Function(...Object.keys(context),`return (${formula});`);
          points=isNaN(fn(...Object.values(context)))?0:fn(...Object.values(context));
        }catch(e){console.error('Ошибка расчёта очков игрока',player.first_name,player.last_name,e);}
      }

      const card=document.createElement('div');
      card.className='roster-card';
      card.innerHTML=`
        <img src="${player.photo_url||'image/ball.svg'}" alt="">
        <div class="name">${player.first_name} ${player.last_name}</div>
        <div class="points">Очки: ${Math.round(points)}</div>
        <div class="club">${player.country}</div>
        <div class="position">${player.position}</div>
      `;
      list.appendChild(card);
    });

    panel.classList.remove('hidden');
  } catch(e) {
    console.error('Ошибка showRoster:', e);
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadLeaderboard();
});
</script>
</body>
</html>
















