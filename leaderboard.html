<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard — EuroFantasy</title>
<link rel="stylesheet" href="style.css">
<style>
/* === LEADERBOARD PAGE === */
.leaderboard-page { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
.leaderboard-page h1 { font-family: 'Petrov Sans', sans-serif; font-size: 2.2rem; margin-bottom: 1rem; text-align: center; color: var(--yellow); }
.leaderboard-table { width: 100%; border-collapse: collapse; background: #2a2a2a; border-radius: 16px; overflow: hidden; box-shadow: 0 0 25px rgba(0,0,0,0.5);}
.leaderboard-table th, .leaderboard-table td { padding: 0.8rem 1rem; text-align: center; font-size: 0.95rem; color: var(--white); border-bottom: 1px solid #444; }
.leaderboard-table thead { background: var(--purple); }
.leaderboard-table tr:nth-child(even) { background: #222; }
.leaderboard-table tr:hover { background: rgba(254,100,28,0.15); transition: background 0.2s ease-in-out; }
.roster-panel { margin-top: 2rem; background: #2a2a2a; border-radius: 16px; padding: 1.5rem; max-height: 400px; overflow-y: auto; box-shadow: 0 0 15px rgba(0,0,0,0.4);}
.roster-card { background: #1c1c1c; border-radius: 12px; padding: 0.8rem; text-align: center; box-shadow: 0 0 8px rgba(0,0,0,0.4); margin-bottom: 0.5rem;}
.roster-card img { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem;}
.name { font-weight: bold; margin-bottom: 0.2rem; }
.stats { font-size: 0.85rem; color: #fefefe; }
</style>
</head>
<body>
<div class="leaderboard-page">
  <h1>Турнирная таблица</h1>
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>Команда</th>
        <th>Тур 1</th>
        <th>Тур 2-3</th>
        <th>Тур 4</th>
        <th>Тур 5</th>
        <th>1/8 Финала</th>
        <th>1/4 Финала</th>
        <th>1/2 Финала</th>
        <th>Финалы</th>
        <th>Итого</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <div class="roster-panel hidden" id="roster-panel">
    <h2>Состав команды</h2>
    <div id="roster-list"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
const supabase = window.supabase.createClient(
  "https://xovxokupvsnnjtskdgvr.supabase.co",
  "YOUR_ANON_KEY"
);

const TOURS = ["1", "2-3", "4", "5", "1/8", "1/4", "1/2", "Финалы"];

let currentUser = null;
async function getCurrentUser() {
  const { data: { user } } = await supabase.auth.getUser();
  currentUser = user;
}

async function calculateTeamPointsForTour(teamId, tourNumber) {
  // tourNumber может быть номером тура или массивом туров ["2","3"]
  let tourFilter = Array.isArray(tourNumber) ? tourNumber : [tourNumber];

  const { data, error } = await supabase
    .from('team_players')
    .select(`
      player:player_id (stats),
      role:role_id (formula)
    `)
    .eq('team_id', teamId);

  if (error || !data) {
    console.error('Ошибка team_players:', error);
    return 0;
  }

  let total = 0;

  for (const [index, p] of data.entries()) {
    const statsAll = p.player?.stats || {};
    const formula = p.role?.formula;
    if (!formula) continue;

    // суммируем очки за указанный тур/туры
    let tourPoints = 0;
    for (const t of tourFilter) {
      const stats = statsAll[t] || {}; // stats должны быть по тур
      const context = {
        points: stats.points || 0,
        assists: stats.assists || 0,
        rebounds: stats.rebounds || 0,
        steals: stats.steals || 0,
        blocks: stats.blocks || 0,
        turnover: stats.turnover || 0,
        threes: stats.threes || 0,
        count: stats.count || 1
      };
      try {
        const fn = new Function(...Object.keys(context), `return (${formula});`);
        const result = fn(...Object.values(context));
        tourPoints += isNaN(result) ? 0 : result;
      } catch(e) {
        console.error('Ошибка в формуле:', formula, e);
      }
    }

    total += tourPoints;
  }

  return Math.round(total);
}

async function loadLeaderboard() {
  const { data: teams, error } = await supabase.from('user_teams').select('id, team_name');
  if (error || !teams) return console.error('Ошибка загрузки команд:', error);

  const tbody = document.getElementById('leaderboard-body');
  tbody.innerHTML = '';

  for (const team of teams) {
    let row = document.createElement('tr');
    row.innerHTML = `<td>${team.team_name}</td>`;
    let totalSum = 0;

    for (const tour of TOURS) {
      let points = await calculateTeamPointsForTour(team.id, tour);
      totalSum += points;

      let cell = document.createElement('td');
      cell.innerHTML = `${points} <button class="show-lineup" data-team-id="${team.id}" data-tour="${tour}">Состав</button>`;
      row.appendChild(cell);
    }

    let totalCell = document.createElement('td');
    totalCell.innerText = totalSum;
    row.appendChild(totalCell);

    tbody.appendChild(row);
  }

  document.querySelectorAll('.show-lineup').forEach(btn => {
    btn.addEventListener('click', async e => {
      const teamId = e.target.dataset.teamId;
      const tour = e.target.dataset.tour;
      await showRoster(teamId, tour);
    });
  });
}

async function showRoster(teamId, tourNumber) {
  const { data: teamPlayers, error } = await supabase.from('team_players')
    .select(`player_id(first_name,last_name,position,country,photo_url,stats), role_id(formula)`)
    .eq('team_id', teamId);

  if (error) return console.error('Ошибка showRoster:', error);

  const panel = document.getElementById('roster-panel');
  const list = document.getElementById('roster-list');
  list.innerHTML = '';

  for (const p of teamPlayers) {
    const player = p.player_id;
    const stats = (player.stats && player.stats[tourNumber]) || {};
    const formula = p.role_id?.formula || '';
    const context = {
      points: stats.points || 0,
      assists: stats.assists || 0,
      rebounds: stats.rebounds || 0,
      steals: stats.steals || 0,
      blocks: stats.blocks || 0,
      turnover: stats.turnover || 0,
      threes: stats.threes || 0,
      count: stats.count || 1
    };

    let playerPoints = 0;
    try {
      const fn = new Function(...Object.keys(context), `return (${formula});`);
      playerPoints = isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
    } catch(e) { console.error('Ошибка формулы игрока:', e); }

    const card = document.createElement('div');
    card.className = 'roster-card';
    card.innerHTML = `
      <img src="${player.photo_url || 'image/ball.svg'}" alt="">
      <div class="name">${player.first_name} ${player.last_name}</div>
      <div class="stats">Очки: ${playerPoints}</div>
      <div class="position">${player.position || ''}</div>
      <div class="club">${player.country || ''}</div>
    `;
    list.appendChild(card);
  }

  panel.classList.remove('hidden');
}

(async () => {
  await getCurrentUser();
  await loadLeaderboard();
})();
</script>
</body>
</html>
