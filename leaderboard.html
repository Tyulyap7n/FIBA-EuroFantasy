<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard ‚Äî EuroFantasy</title>
<style>
/* === LEADERBOARD PAGE === */
:root{
  --purple: #633EDC;
  --orange: #FE641C;
  --yellow: #FDE600;
  --black: #1c1c1c;
  --white: #ffffff;
  --muted: #bfbfbf;
  --panel-max-height: 1600px;
}

@font-face {
  font-family: 'Petrov Sans';
  src: url('/fonts/PetrovSans-Trial-Bold.otf') format('opentype');
  font-weight: bold;
  font-style: normal;
  font-display: swap;
}
  body{
  margin: 0;
  background: var(--black);
  color: var(--white);
  font-family: 'Petrov Sans', Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  font-size: 20px;
  line-height: 1.2;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
  .site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--purple);
  padding: 10px 20px;
  border-bottom: 4px solid var(--yellow);
}
.site-header img.logo { height: 50px; display:block; }
.header-links { display:flex; gap:20px; align-items:center; }
.header-link { color: var(--white); text-decoration: none; font-weight: 700; }
.header-link:hover { color: var(--yellow); }
/* –ß–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ —è—á–µ–π–∫–µ */
.cell-class {
  color: black;
}

.show-lineup {
  background-color: var(--yellow);
  color: black; /* –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ */
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.show-lineup:hover {
  opacity: 0.9;
}

/* Alternative/custom header usage */
.custom-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  background: var(--black);
  border-bottom: 3px solid var(--white);
}
/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ */
.leaderboard-page {
  max-width: 1200px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –±–ª–æ–∫ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
  padding: 2rem 1rem; /* –û—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É 2rem, —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ 1rem */
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.leaderboard-page h1 {
  font-family: 'Petrov Sans', sans-serif; /* –®—Ä–∏—Ñ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  font-size: 2.2rem; /* –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  margin-bottom: 1rem; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  text-align: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  color: var(--yellow); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π CSS */
  letter-spacing: 1px; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±—É–∫–≤–∞–º–∏ */
}

/* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ */
.leaderboard-table {
  width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
  border-collapse: collapse; /* –£–±–∏—Ä–∞–µ—Ç –¥–≤–æ–π–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ */
  background: var(--purple); /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–∞–±–ª–∏—Ü—ã */
  border-radius: 16px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ —Ç–∞–±–ª–∏—Ü—ã */
  overflow: hidden; /* –ß—Ç–æ–±—ã —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º */
  box-shadow: 0 0 25px rgba(0,0,0,0.5); /* –¢–µ–Ω—å –≤–æ–∫—Ä—É–≥ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ–±—ä—ë–º–∞ */
}

/* –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã */
.leaderboard-table thead {
  background: var(--purple); /* –§–æ–Ω —à–∞–ø–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */
}

/* –Ø—á–µ–π–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∏ –¥–∞–Ω–Ω—ã–µ) */
.leaderboard-table th, .leaderboard-table td {
  padding: 0.8rem 1rem; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  text-align: left; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–ª–µ–≤–∞ */
  font-size: 0.95rem; /* –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
  color: var(--white); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
}

/* –¢–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã */
.leaderboard-table th {
  font-weight: bold; /* –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
  text-transform: uppercase; /* –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä */
}

/* –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
.leaderboard-table tr:nth-child(even) {
  background: #222; /* –¢—ë–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —á—ë—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
}

/* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É */
.leaderboard-table tr:hover {
  background: rgba(254,100,28,0.15); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ñ–æ–Ω */
  transition: 0.2s; /* –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è "–º–æ–µ–π" –∫–æ–º–∞–Ω–¥—ã */
.leaderboard-table tr.me {
  background: rgba(253,230,0,0.25); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∂—ë–ª—Ç—ã–π —Ñ–æ–Ω */
  font-weight: bold; /* –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
}

/* –ü–∞–Ω–µ–ª—å —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–∞–Ω–¥—ã */
.roster-panel {
  margin-top: 2rem; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –æ—Ç —Ç–∞–±–ª–∏—Ü—ã */
  background: var(--purple); /* –¢—ë–º–Ω—ã–π —Ñ–æ–Ω –ø–∞–Ω–µ–ª–∏ */
  border-radius: 16px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */
  padding: 1.5rem; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  max-height: var(--panel-max-height); /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–∞–Ω–µ–ª–∏ */
  overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
  box-shadow: 0 0 15px rgba(0,0,0,0.4); /* –¢–µ–Ω—å –ø–∞–Ω–µ–ª–∏ –¥–ª—è –æ–±—ä—ë–º–∞ */
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏ —Å–æ—Å—Ç–∞–≤–∞ */
.roster-panel h2 {
  color: var(--orange); /* –û—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  font-size: 1.6rem; /* –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
  margin-bottom: 1rem; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
}

/* –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–≥—Ä–æ–∫–æ–≤ */
.roster-list {
  display: grid; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º grid –¥–ª—è —Å–µ—Ç–∫–∏ */
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ */
  gap: 1rem; /* –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ */
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–≥—Ä–æ–∫–∞ */
.roster-card {
  background: var(--purple);  /* –¢—ë–º–Ω—ã–π —Ñ–æ–Ω */
  border-radius: 12px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ */
  padding: 0.8rem; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  text-align: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  box-shadow: 0 0 8px rgba(0,0,0,0.4); /* –¢–µ–Ω—å –∫–∞—Ä—Ç–æ—á–∫–∏ */
}

/* –§–æ—Ç–æ –∏–≥—Ä–æ–∫–∞ */
.roster-card img {
  width: 64px; /* –®–∏—Ä–∏–Ω–∞ */
  height: 64px; /* –í—ã—Å–æ—Ç–∞ */
  border-radius: 50%; /* –ö—Ä—É–≥–ª–∞—è —Ñ–æ—Ä–º–∞ */
  object-fit: cover; /* –û–±—Ä–µ–∑–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É */
  margin-bottom: 0.5rem; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
}

/* –ò–º—è –∏–≥—Ä–æ–∫–∞ */
.roster-card .name {
  font-size: 0.9rem; /* –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
  font-weight: bold; /* –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç */
  margin-bottom: 0.3rem; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
  color: var(--orange); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
}

/* –ö–ª—É–±/—Å—Ç—Ä–∞–Ω–∞ –∏–≥—Ä–æ–∫–∞ */
.roster-card .club {
  font-size: 0.8rem; /* –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
  color: var(--orange); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
}

/* –û—á–∫–∏ –∏–≥—Ä–æ–∫–∞ */
.roster-card .points {
  font-size: 0.85rem; /* –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
  color: var(--orange);  /* –¶–≤–µ—Ç –∂—ë–ª—Ç—ã–π, –≤—ã–¥–µ–ª—è–µ–º */
  margin-bottom: 0.3rem; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
}
a img {
  height: 50px;
  width: auto;
  display: block; /* —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º */
}  
</style>

</head>
  <script src="script.js"></script>
<body>
  <header class="site-header">
  <div class="logo-container">
    <a href="dashboard.html"> <img src="image/logo.jpg" alt="logo"></a>
  </div>
</header>
<div class="leaderboard-page">
  <h1>LEADERBOARD</h1>
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>TEAM</th>
        <th>TOUR 1</th>
        <th>TOUR 2-3</th>
        <th>TOUR 4</th>
        <th>TOUR 5</th>
        <th>1/8</th>
        <th>1/4</th>
        <th>1/2</th>
        <th>FINALS</th>
        <th>SUMMARY</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <div class="roster-panel hidden" id="roster-panel">
    <h2>TEAM ROSTER</h2>
    <div class="roster-list" id="roster-list"></div>
    <div id="team-history"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
const supabase = window.supabase.createClient(
  "https://xovxokupvsnnjtskdgvr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvdnhva3VwdnNubmp0c2tkZ3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDk4NjMsImV4cCI6MjA3MDQyNTg2M30.Vl5Z9DABFmHQWGtfbyuAZGGgfX4hDYGAPD8C7fr540E"
);

const TOURS = ["1","2-3","4","5","1/8","1/4","1/2","–§–∏–Ω–∞–ª—ã"];

async function calculateTeamPoints(teamId, currentTour = 1) {
  try {
  const { data: teamPlayers } = await supabase
    .from('team_players')
    .select('player_id, role_id (formula)')
    .eq('team_id', teamId)
    .eq('tour_id', currentTour); // üëà –≤–æ—Ç —ç—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º

    if (!teamPlayers || teamPlayers.length === 0) return 0;

    const playerIds = teamPlayers.map(p => p.player_id);
    const { data: statsData } = await supabase
      .from('player_stats')
      .select('*')
      .in('player_id', playerIds)
      .eq('tour', currentTour);

    const statsMap = {};
    (statsData||[]).forEach(s => statsMap[s.player_id]=s);

    let total=0;
    teamPlayers.forEach(p=>{
      const stats=statsMap[p.player_id]||{};
      const formula=p.role_id?.formula;
      if (!formula) return;

      const context = { ...stats, count: stats.count||1 };
      try{
        const fn=new Function(...Object.keys(context),`return (${formula});`);
        total += isNaN(fn(...Object.values(context))) ? 0 : fn(...Object.values(context));
      }catch(e){console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º—É–ª—ã:', formula, e);}
    });
    return Math.round(total);
  } catch(e) {
    console.error('–û—à–∏–±–∫–∞ calculateTeamPoints:', e);
    return 0;
  }
}

async function loadLeaderboard() {
  try {
    const { data: teams } = await supabase.from('user_teams').select('id, team_name');
    const tbody = document.getElementById('leaderboard-body');
    tbody.innerHTML = '';

    for(const team of teams){
      const row = document.createElement('tr');
      let totalSum = 0;
      row.innerHTML = `<td>${team.team_name}</td>`;

      for(const tour of TOURS){
        const tourNumbers = tour.includes("-") ? tour.split("-").map(Number) : [tour=="–§–∏–Ω–∞–ª—ã"?99:Number(tour)];
        let points = 0;
        for(const t of tourNumbers) points += await calculateTeamPoints(team.id, t);
        totalSum += points;

        const cell = document.createElement('td');
        cell.innerHTML = `${points} <button class="show-lineup" data-team-id="${team.id}" data-tour="${tour}">ROSTER</button>`;
        row.appendChild(cell);
      }

      const totalCell = document.createElement('td');
      totalCell.innerText = totalSum;
      row.appendChild(totalCell);

      tbody.appendChild(row);
    }

    document.querySelectorAll('.show-lineup').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        const teamId=e.target.dataset.teamId;
        const tour=e.target.dataset.tour;
        await showRoster(teamId, tour.includes("-") ? parseInt(tour.split("-")[0]) : tour=="–§–∏–Ω–∞–ª—ã"?99:parseInt(tour));
      });
    });
  } catch(e) {
    console.error('–û—à–∏–±–∫–∞ loadLeaderboard:', e);
  }
}
async function renderTeamHistory(teamId) {
  if (!ensureSupabase() || !teamId) return;

  try {
    const { data, error } = await supabase
      .from("team_players")
      .select("tour_id, player_id, players(name, photo)")
      .eq("team_id", teamId)
      .order("tour_id", { ascending: true });

    if (error) throw error;

    const historyEl = document.getElementById("team-history");
    historyEl.innerHTML = "";

    // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç—É—Ä–∞–º
    const groupedByTour = {};
    data.forEach(p => {
      if (!groupedByTour[p.tour_id]) groupedByTour[p.tour_id] = [];
      groupedByTour[p.tour_id].push(p);
    });

    // —Ä–µ–Ω–¥–µ—Ä –ø–æ –∫–∞–∂–¥–æ–º—É —Ç—É—Ä—É
    Object.keys(groupedByTour).forEach(tourId => {
      const tourBlock = document.createElement("div");
      tourBlock.className = "tour-block";

      // –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç—É—Ä–∞
      const tourTitle = document.createElement("h3");
      tourTitle.textContent = getTourLabel(parseInt(tourId));
      tourBlock.appendChild(tourTitle);

      // —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
      const playersList = document.createElement("div");
      playersList.className = "players-list";

      groupedByTour[tourId].forEach(p => {
        const playerDiv = document.createElement("div");
        playerDiv.className = "player-card";

        const img = document.createElement("img");
        img.src = p.players?.photo || DEFAULT_AVATAR;
        img.alt = p.players?.name || "Player";

        const name = document.createElement("span");
        name.textContent = p.players?.name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";

        playerDiv.appendChild(img);
        playerDiv.appendChild(name);
        playersList.appendChild(playerDiv);
      });

      tourBlock.appendChild(playersList);
      historyEl.appendChild(tourBlock);
    });

  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ—Å—Ç–∞–≤–∞:", err);
  }
}



async function showRoster(teamId, currentTour=1){
  try {
    const { data: teamPlayers } = await supabase
      .from('team_players')
      .select('player_id, role_id (formula)')
      .eq('team_id', teamId)
      .eq('tour_id', currentTour); // ‚úÖ —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç—É—Ä—É

    if(!teamPlayers) return;

    const playerIds = teamPlayers.map(p=>p.player_id);

    const { data: statsData } = await supabase
      .from('player_stats')
      .select('*')
      .in('player_id', playerIds)
      .eq('tour', currentTour);

    const statsMap = {};
    (statsData||[]).forEach(s=>statsMap[s.player_id]=s);

    const { data: playersData } = await supabase
      .from('players')
      .select('*')
      .in('id', playerIds);

    const playersMap = {};
    (playersData||[]).forEach(p=>playersMap[p.id]=p);

    const panel = document.getElementById('roster-panel');
    const list = document.getElementById('roster-list');
    list.innerHTML='';

    teamPlayers.forEach(p=>{
      const stats=statsMap[p.player_id]||{};
      const formula=p.role_id?.formula;
      const player=playersMap[p.player_id];
      if(!player) return;

      let points=0;
      if(formula){
        const context = { ...stats, count: stats.count||1 };
        try{
          const fn=new Function(...Object.keys(context),`return (${formula});`);
          points=isNaN(fn(...Object.values(context)))?0:fn(...Object.values(context));
        }catch(e){console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –æ—á–∫–æ–≤ –∏–≥—Ä–æ–∫–∞',player.first_name,player.last_name,e);}
      }

      const card=document.createElement('div');
      card.className='roster-card';
      card.innerHTML=`
        <img src="${player.photo_url||'image/ball.svg'}" alt="">
        <div class="name">${player.first_name} ${player.last_name}</div>
        <div class="points">–û—á–∫–∏: ${Math.round(points)}</div>
        <div class="club">${player.country}</div>
      `;
      list.appendChild(card);
    });

    panel.classList.remove('hidden');
  } catch(e) {
    console.error('–û—à–∏–±–∫–∞ showRoster:', e);
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadLeaderboard();
});


</script>
</body>
</html>





