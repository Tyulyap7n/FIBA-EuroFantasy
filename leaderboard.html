<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard — EuroFantasy</title>
    <link rel="shortcut icon" href="image/img.jpg" type="image/jpg">
<style>
/* === LEADERBOARD PAGE === */
:root{
  --purple: #633EDC;
  --orange: #FE641C;
  --yellow: #FDE600;
  --black: #1c1c1c;
  --white: #ffffff;
  --muted: #bfbfbf;
  --panel-max-height: 1600px;
}
@font-face {
  font-family: 'Petrov Sans';
  src: url('/fonts/PetrovSans-Trial-Bold.otf') format('opentype');
  font-weight: bold;
  font-style: normal;
  font-display: swap;
}
  body{
  margin: 0;
  background: var(--black);
  color: var(--white);
  font-family: 'Petrov Sans', Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  font-size: 20px;
  line-height: 1.2;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
  .site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--purple);
  padding: 10px 20px;
  border-bottom: 4px solid var(--yellow);
}
.site-header img.logo { height: 50px; display:block; }
.header-links { display:flex; gap:20px; align-items:center; }
.header-link { color: var(--white); text-decoration: none; font-weight: 700; }
.header-link:hover { color: var(--yellow); }
/* Черный цвет текста в ячейке */
.cell-class {
  color: black;
}
.show-lineup {
  background-color: var(--yellow);
  color: black; /* Текст кнопки */
  border: none;
  padding: 3px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.7rem;
  margin-left: 5px;
}
.show-lineup:hover {
  opacity: 0.9;
}
/* Alternative/custom header usage */
.custom-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  background: var(--black);
  border-bottom: 3px solid var(--white);
}
/* Основной контейнер страницы лидерборда */
.leaderboard-page {
  max-width: 1200px; /* Ограничиваем максимальную ширину страницы */
  margin: 0 auto; /* Центрируем блок по горизонтали */
  padding: 2rem 1rem; /* Отступы сверху/снизу 2rem, слева/справа 1rem */
}
/* Заголовок страницы */
.leaderboard-page h1 {
  font-family: 'Petrov Sans', sans-serif; /* Шрифт заголовка */
  font-size: 2.2rem; /* Размер текста заголовка */
  margin-bottom: 1rem; /* Отступ снизу от заголовка */
  text-align: center; /* Выравнивание по центру */
  color: var(--yellow); /* Цвет текста из переменной CSS */
  letter-spacing: 1px; /* Расстояние между буквами */
}
/* Таблица лидерборда */
.leaderboard-table {
  width: 100%; /* Занимает всю ширину контейнера */
  border-collapse: collapse; /* Убирает двойные границы между ячейками */
  background: var(--purple); /* Цвет фона таблицы */
  border-radius: 16px; /* Скругление углов таблицы */
  overflow: hidden; /* Чтобы скругление работало с содержимым */
  box-shadow: 0 0 25px rgba(0,0,0,0.5); /* Тень вокруг таблицы для объёма */
}
/* Шапка таблицы */
.leaderboard-table thead {
  background: var(--purple); /* Фон шапки таблицы */
}
/* Ячейки таблицы (и заголовки, и данные) */
.leaderboard-table th, .leaderboard-table td {
  padding: 0.5rem 0.6rem; /* Внутренние отступы */
  text-align: center; /* Выравнивание текста по центру */
  font-size: 0.8rem; /* Размер текста */
  color: var(--white); /* Цвет текста */
  white-space: nowrap; /* Запрет переноса */
}
/* Только заголовки таблицы */
.leaderboard-table th {
  font-weight: bold; /* Жирный шрифт */
  text-transform: uppercase; /* Преобразование текста в верхний регистр */
}
/* Чередование строк таблицы */
.leaderboard-table tr:nth-child(even) {
  background: #222; /* Тёмный фон для чётных строк */
}
/* Эффект при наведении на строку */
.leaderboard-table tr:hover {
  background: rgba(254,100,28,0.15); /* Полупрозрачный оранжевый фон */
  transition: 0.2s; /* Плавное изменение фона */
}
/* Подсветка строки для "моей" команды */
.leaderboard-table tr.me {
  background: rgba(253,230,0,0.25); /* Полупрозрачный жёлтый фон */
  font-weight: bold; /* Жирный текст */
}
/* Пагинация */
.pagination {
  display: flex;
  justify-content: center;
  margin-top: 20px;
  gap: 5px;
}
.pagination button {
  background: var(--purple);
  color: var(--white);
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
.pagination button:hover {
  background: var(--yellow);
  color: black;
}
.pagination button.active {
  background: var(--orange);
  color: black;
}
/* Панель состава команды */
.roster-panel {
  margin-top: 2rem; /* Отступ сверху от таблицы */
  background: var(--purple); /* Тёмный фон панели */
  border-radius: 16px; /* Скругление углов */
  padding: 1.5rem; /* Внутренние отступы */
  max-height: var(--panel-max-height); /* Максимальная высота панели */
  overflow-y: auto; /* Прокрутка по вертикали при переполнении */
  box-shadow: 0 0 15px rgba(0,0,0,0.4); /* Тень панели для объёма */
}
/* Заголовок панели состава */
.roster-panel h2 {
  color: var(--orange); /* Оранжевый цвет заголовка */
  font-size: 1.6rem; /* Размер текста */
  margin-bottom: 1rem; /* Отступ снизу */
}
/* Сетка карточек игроков */
.roster-list {
  display: grid; /* Используем grid для сетки */
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Автоматическое распределение колонок */
  gap: 1rem; /* Расстояние между карточками */
}
/* Карточка игрока */
.roster-card {
  background: var(--purple);  /* Тёмный фон */
  border-radius: 12px; /* Скругление углов */
  padding: 0.8rem; /* Внутренние отступы */
  text-align: center; /* Выравнивание содержимого по центру */
  box-shadow: 0 0 8px rgba(0,0,0,0.4); /* Тень карочки */
}
/* Фото игрока */
.roster-card img {
  width: 64px; /* Ширина */
  height: 64px; /* Высота */
  border-radius: 50%; /* Круглая форма */
  object-fit: cover; /* Обрезка по размеру */
  margin-bottom: 0.5rem; /* Отступ снизу */
}
/* Имя игрока */
.roster-card .name {
  font-size: 0.9rem; /* Размер текста */
  font-weight: bold; /* Жирный шрифт */
  margin-bottom: 0.3rem; /* Отступ снизу */
  color: var(--orange); /* Цвет текста */
}
/* Роль игрока */
.roster-card .role {
  font-size: 0.75rem; /* Размер текста */
  color: var(--yellow); /* Цвет текста */
  margin-bottom: 0.3rem; /* Отступ снизу */
  font-style: italic;
}
/* Клуб/страна игрока */
.roster-card .club {
  font-size: 0.8rem; /* Размер текста */
  color: var(--orange); /* Цвет текста */
}
/* Очки игрока */
.roster-card .points {
  font-size: 0.85rem; /* Размер текста */
  color: var(--orange);  /* Цвет жёлтый, выделяем */
  margin-bottom: 0.3rem; /* Отступ снизу */
}
a img {
  height: 50px;
  width: auto;
  display: block; /* чтобы убрать возможные отступы под изображением */
}
.hidden { display: none; }
.loading {
  text-align: center;
  padding: 2rem;
  color: var(--yellow);
  font-size: 1.2rem;
}
</style>
</head>
<body>
  <header class="site-header">
  <div class="logo-container">
    <a href="dashboard.html"> <img src="image/logo.jpg" alt="logo"></a>
  </div>
</header>
<div class="leaderboard-page">
  <h1>LEADERBOARD</h1>
  <div id="loading" class="loading">Загрузка данных...</div>
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>Place</th>
        <th>TEAM</th>
        <th>TOUR 1</th>
        <th>TOUR 2-3</th>
        <th>TOUR 4</th>
        <th>TOUR 5</th>
        <th>1/8</th>
        <th>1/4</th>
        <th>1/2</th>
        <th>FINALS</th>
        <th>SUMMARY</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>
  <div class="pagination" id="pagination"></div>
  <div class="roster-panel hidden" id="roster-panel">
    <h2>TEAM ROSTER</h2>
    <div class="roster-list" id="roster-list"></div>
    <div id="team-history"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
// Правильные credentials для Supabase
const SUPABASE_URL = "https://xovxokupvsnnjtskdgvr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvdnhva3VwdnNubmp0c2tkZ3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDk4NjMsImV4cCI6MjA3MDQyNTg2M30.Vl5Z9DABFmHQWGtfbyuAZGGgfX4hDYGAPD8C7fr540E";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ITEMS_PER_PAGE = 15;
let currentPage = 1;
let allTeams = [];

// Кэш для данных
let cachedData = {
  teams: [],
  teamPlayers: [],
  playerStats: [],
  roles: [],
  players: []
};

async function loadAllData() {
  try {
    console.log('Начинаем загрузку данных...');
    
    // Загружаем все данные одним запросом
    const [
      { data: teams, error: teamsError },
      { data: teamPlayers, error: teamPlayersError },
      { data: playerStats, error: statsError },
      { data: roles, error: rolesError },
      { data: players, error: playersError }
    ] = await Promise.all([
      supabase.from('user_teams').select('id, team_name'),
      supabase.from('team_players').select('team_id, player_id, tour_id, role_id'),
      supabase.from('player_stats').select('*'),
      supabase.from('roles').select('id, name, formula'),
      supabase.from('players').select('id, first_name, last_name, photo_url, country')
    ]);

    // Проверяем ошибки
    const errors = [teamsError, teamPlayersError, statsError, rolesError, playersError].filter(error => error);
    if (errors.length > 0) {
      console.error('Ошибки при загрузке данных:', errors);
      throw new Error(`Ошибки загрузки: ${errors.map(e => e.message).join(', ')}`);
    }

    cachedData = {
      teams: teams || [],
      teamPlayers: teamPlayers || [],
      playerStats: playerStats || [],
      roles: roles || [],
      players: players || []
    };

    console.log('Данные успешно загружены:', {
      teams: cachedData.teams.length,
      teamPlayers: cachedData.teamPlayers.length,
      playerStats: cachedData.playerStats.length,
      roles: cachedData.roles.length,
      players: cachedData.players.length
    });

    // Отладочная информация о составе команд
    console.log('Пример данных team_players:', cachedData.teamPlayers.slice(0, 5));
    console.log('Уникальные team_id:', [...new Set(cachedData.teamPlayers.map(tp => tp.team_id))]);
    console.log('Уникальные tour_id:', [...new Set(cachedData.teamPlayers.map(tp => tp.tour_id))]);

    return true;
  } catch (error) {
    console.error('Критическая ошибка загрузки данных:', error);
    return false;
  }
}

function calculatePlayerPoints(playerId, roleId, tourId) {
  const role = cachedData.roles.find(r => r.id === roleId);
  if (!role || !role.formula) {
    console.warn('Роль или формула не найдены для playerId:', playerId, 'roleId:', roleId);
    return 0;
  }

  const numericTourId = Number(tourId);
  const stats = cachedData.playerStats.find(s =>
    s.player_id === playerId && Number(s.tour) === numericTourId
  ) || {};

  const context = { ...stats, count: stats.count || 1 };
  try {
    const fn = new Function(...Object.keys(context), `return (${role.formula});`);
    const tourPoints = fn(...Object.values(context));
    return isNaN(tourPoints) ? 0 : tourPoints;
  } catch (e) {
    console.error('Ошибка формулы:', role.formula, 'для игрока:', playerId, e);
    return 0;
  }
}
function calculateTeamPoints(teamId) {
  const teamIdStr = String(teamId);
  const teamPlayers = cachedData.teamPlayers.filter(tp => String(tp.team_id) === teamIdStr);

  if (teamPlayers.length === 0) {
    console.warn('Нет игроков в команде:', teamId);
    return {
      tour_1: 0,
      tour_2_3: 0,
      tour_4: 0,
      tour_5: 0,
      tour_6: 0,
      tour_7: 0,
      tour_8: 0,
      tour_finals: 0,
      total: 0
    };
  }

  const pointsByTour = {
    tour_1: 0,
    tour_2_3: 0,
    tour_4: 0,
    tour_5: 0,
    tour_6: 0,
    tour_7: 0,
    tour_8: 0,
    tour_finals: 0,
    total: 0
  };

  // Собираем уникальные комбинации игрок + роль
  const uniquePlayerRoles = {};

  teamPlayers.forEach(tp => {
    const key = `${tp.player_id}_${tp.role_id}`;
    if (!uniquePlayerRoles[key]) {
      uniquePlayerRoles[key] = {
        player_id: tp.player_id,
        role_id: tp.role_id,
        tours: new Set()
      };
    }
    uniquePlayerRoles[key].tours.add(Number(tp.tour_id));
  });

  // Рассчитываем очки для каждого уникального игрока и роли
  Object.values(uniquePlayerRoles).forEach(playerRole => {
    const { player_id, role_id, tours } = playerRole;

    // Очки за тур 2 и тур 3 суммируем вместе
    let tour2Points = 0;
    let tour3Points = 0;

    if (tours.has(2)) {
      tour2Points = calculatePlayerPoints(player_id, role_id, 2);
    }
    if (tours.has(3)) {
      tour3Points = calculatePlayerPoints(player_id, role_id, 3);
    }

    pointsByTour.tour_2_3 += tour2Points + tour3Points;

    // Очки за остальные туры
    tours.forEach(tourId => {
      if (tourId !== 2 && tourId !== 3) {
        const points = calculatePlayerPoints(player_id, role_id, tourId);
        switch (tourId) {
          case 1:
            pointsByTour.tour_1 += points;
            break;
          case 4:
            pointsByTour.tour_4 += points;
            break;
          case 5:
            pointsByTour.tour_5 += points;
            break;
          case 6:
            pointsByTour.tour_6 += points;
            break;
          case 7:
            pointsByTour.tour_7 += points;
            break;
          case 8:
            pointsByTour.tour_8 += points;
            break;
          case 99:
            pointsByTour.tour_finals += points;
            break;
          default:
            console.warn('Неизвестный тур:', tourId, 'для игрока:', player_id);
        }
      }
    });
  });

  // Округляем значения
  Object.keys(pointsByTour).forEach(key => {
    if (key !== 'total') {
      pointsByTour[key] = Math.round(pointsByTour[key]);
    }
  });

  // Считаем общую сумму
  pointsByTour.total = Math.round(
    pointsByTour.tour_1 +
    pointsByTour.tour_2_3 +
    pointsByTour.tour_4 +
    pointsByTour.tour_5 +
    pointsByTour.tour_6 +
    pointsByTour.tour_7 +
    pointsByTour.tour_8 +
    pointsByTour.tour_finals
  );

  return pointsByTour;
}

async function loadLeaderboard() {
    cachedData = { teams: [], teamPlayers: [], playerStats: [], roles: [], players: [] }; // Очистка кэша
  const loadingElement = document.getElementById('loading');
  loadingElement.classList.remove('hidden');
  
  try {
    console.log('Инициализация Supabase...');
    
    // Проверяем подключение к Supabase
    const { data, error } = await supabase.from('user_teams').select('count').limit(1);
    if (error) {
      throw new Error(`Ошибка подключения к Supabase: ${error.message}`);
    }

    // Загружаем все данные
    const success = await loadAllData();
    if (!success) {
      throw new Error('Не удалось загрузить данные из базы');
    }

    // Рассчитываем очки для каждой команды
    allTeams = cachedData.teams.map(team => {
      const points = calculateTeamPoints(team.id);
      return {
        teamId: team.id,
        name: team.team_name,
        ...points
      };
    });

    // Сортируем по убыванию очков
    allTeams.sort((a, b) => b.total - a.total);

    console.log('Лидерборд сформирован. Команд:', allTeams.length);

    // Скрываем индикатор загрузки
    loadingElement.classList.add('hidden');
    
    // Рендерим таблицу
    renderPage(currentPage);
    renderPagination();

  } catch (error) {
    console.error('Ошибка загрузки лидерборда:', error);
    loadingElement.innerHTML = `
      <div style="color: var(--orange); margin-bottom: 1rem;">
        Ошибка загрузки данных: ${error.message}
      </div>
      <button onclick="location.reload()" style="
        background: var(--yellow);
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      ">Обновить страницу</button>
    `;
  }
}

function renderPage(page) {
  const tbody = document.getElementById('leaderboard-body');
  tbody.innerHTML = '';

  const start = (page - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  const pageTeams = allTeams.slice(start, end);

  if (pageTeams.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = `<td colspan="11" style="text-align: center; color: var(--orange);">Нет данных для отображения</td>`;
    tbody.appendChild(row);
    return;
  }

  pageTeams.forEach((team, index) => {
    const row = document.createElement('tr');
    const place = start + index + 1;

    row.innerHTML = `
      <td>${place}</td>
      <td>${team.name}</td>
      <td>${team.tour_1} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="1">ROSTER</button></td>
      <td>${team.tour_2_3} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="2">ROSTER</button></td>
      <td>${team.tour_4} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="4">ROSTER</button></td>
      <td>${team.tour_5} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="5">ROSTER</button></td>
      <td>${team.tour_6} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="6">ROSTER</button></td>
      <td>${team.tour_7} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="7">ROSTER</button></td>
      <td>${team.tour_8} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="8">ROSTER</button></td>
      <td>${team.tour_finals} <button class="show-lineup" data-team-id="${team.teamId}" data-tour="99">ROSTER</button></td>
      <td>${team.total}</td>
    `;

    tbody.appendChild(row);
  });

  // Добавляем обработчики событий для кнопок ROSTER
  addRosterButtonListeners();
}

function addRosterButtonListeners() {
  // Используем делегирование событий на таблице
  document.getElementById('leaderboard-body').addEventListener('click', (e) => {
    if (e.target.classList.contains('show-lineup')) {
      const teamId = e.target.dataset.teamId;
      const tour = parseInt(e.target.dataset.tour);
      showRoster(teamId, tour);
    }
  });
}

function renderPagination() {
  const paginationEl = document.getElementById('pagination');
  paginationEl.innerHTML = '';

  const pageCount = Math.ceil(allTeams.length / ITEMS_PER_PAGE);

  if (pageCount <= 1) return;

  const prevButton = document.createElement('button');
  prevButton.textContent = '←';
  prevButton.disabled = currentPage === 1;
  prevButton.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
      renderPagination();
    }
  });
  paginationEl.appendChild(prevButton);

  // Показываем только ограниченное количество страниц
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(pageCount, startPage + 4);

  for (let i = startPage; i <= endPage; i++) {
    const pageButton = document.createElement('button');
    pageButton.textContent = i;
    if (i === currentPage) {
      pageButton.classList.add('active');
    }
    pageButton.addEventListener('click', () => {
      currentPage = i;
      renderPage(currentPage);
      renderPagination();
    });
    paginationEl.appendChild(pageButton);
  }

  const nextButton = document.createElement('button');
  nextButton.textContent = '→';
  nextButton.disabled = currentPage === pageCount;
  nextButton.addEventListener('click', () => {
    if (currentPage < pageCount) {
      currentPage++;
      renderPage(currentPage);
      renderPagination();
    }
  });
  paginationEl.appendChild(nextButton);
}

async function showRoster(teamId, currentTour = 1) {
  try {
    console.log('Показ состава команды:', teamId, 'тур:', currentTour);

    const teamIdStr = String(teamId);

    // Получаем всех игроков команды для указанного тура
    const teamPlayers = cachedData.teamPlayers.filter(
      tp => String(tp.team_id) === teamIdStr && Number(tp.tour_id) === currentTour
    );

    console.log('Найдено игроков в составе:', teamPlayers.length, 'для команды', teamId, 'тура', currentTour);

    if (teamPlayers.length === 0) {
      const allTeamPlayers = cachedData.teamPlayers.filter(tp => String(tp.team_id) === teamIdStr);
      console.log('Все игроки команды:', allTeamPlayers);
      console.log('Доступные туры для команды:', [...new Set(allTeamPlayers.map(tp => tp.tour_id))]);

      alert(`Нет данных о составе команды для тура ${currentTour}. Доступные туры: ${[...new Set(allTeamPlayers.map(tp => tp.tour_id))].join(', ')}`);
      return;
    }

    const panel = document.getElementById('roster-panel');
    const list = document.getElementById('roster-list');
    list.innerHTML = '';

    for (const tp of teamPlayers) {
      const player = cachedData.players.find(p => p.id === tp.player_id);
      const role = cachedData.roles.find(r => r.id === tp.role_id);

      if (!player) {
        console.warn('Игрок не найден:', tp.player_id);
        continue;
      }

      // Рассчитываем очки игрока за тура 2 и 3, если текущий тур 2 или 3
      let points;
      if (currentTour === 2 || currentTour === 3) {
        const tour2Points = calculatePlayerPoints(tp.player_id, tp.role_id, 2);
        const tour3Points = calculatePlayerPoints(tp.player_id, tp.role_id, 3);
        points = tour2Points + tour3Points;
      } else {
        points = calculatePlayerPoints(tp.player_id, tp.role_id, currentTour);
      }

      const formattedPoints = (points % 1 === 0) ? Math.round(points) : points.toFixed(1);

      const card = document.createElement('div');
      card.className = 'roster-card';
      card.innerHTML = `
        <img src="${player.photo_url || 'image/ball.svg'}" alt="${player.first_name} ${player.last_name}"
             onerror="this.src='image/ball.svg'">
        <div class="role">${role?.name || 'Без роли'}</div>
        <div class="name">${player.first_name} ${player.last_name}</div>
        <div class="club">${player.country || 'Не указано'}</div>
        <div class="points">Очки: ${formattedPoints}</div>
      `;
      list.appendChild(card);
    }

    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth' });

  } catch (e) {
    console.error('Ошибка showRoster:', e);
    alert('Ошибка при загрузке состава команды');
  }
}

// Закрытие панели состава при клике вне ее
document.addEventListener('click', (e) => {
  const panel = document.getElementById('roster-panel');
  if (!panel.classList.contains('hidden') && 
      !e.target.closest('.roster-panel') && 
      !e.target.classList.contains('show-lineup')) {
    panel.classList.add('hidden');
  }
});

// Запускаем загрузку при готовности DOM
document.addEventListener("DOMContentLoaded", loadLeaderboard);
</script>
</body>
</html>








