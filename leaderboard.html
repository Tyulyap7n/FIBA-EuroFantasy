<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Leaderboard — EuroFantasy</title>
<link rel="shortcut icon" href="image/img.jpg" type="image/jpg">
<style>
/* === LEADERBOARD PAGE === */
:root{
  --purple: #633EDC;
  --orange: #FE641C;
  --yellow: #FDE600;
  --black: #1c1c1c;
  --white: #ffffff;
  --muted: #bfbfbf;
  --panel-max-height: 1600px;
}

@font-face {
  font-family: 'Petrov Sans';
  src: url('/fonts/PetrovSans-Trial-Bold.otf') format('opentype');
  font-weight: bold;
  font-style: normal;
  font-display: swap;
}
body{
  margin: 0;
  background: var(--black);
  color: var(--white);
  font-family: 'Petrov Sans', Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  font-size: 20px;
  line-height: 1.2;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--purple);
  padding: 10px 20px;
  border-bottom: 4px solid var(--yellow);
}
.site-header img.logo { height: 50px; display:block; }
.header-links { display:flex; gap:20px; align-items:center; }
.header-link { color: var(--white); text-decoration: none; font-weight: 700; }
.header-link:hover { color: var(--yellow); }

.cell-class {
  color: black;
}

.show-lineup {
  background-color: var(--yellow);
  color: black;
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.show-lineup:hover {
  opacity: 0.9;
}

.custom-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  background: var(--black);
  border-bottom: 3px solid var(--white);
}

.leaderboard-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

.leaderboard-page h1 {
  font-family: 'Petrov Sans', sans-serif;
  font-size: 2.2rem;
  margin-bottom: 1rem;
  text-align: center;
  color: var(--yellow);
  letter-spacing: 1px;
}

.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--purple);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 0 25px rgba(0,0,0,0.5);
}

.leaderboard-table thead {
  background: var(--purple);
}

.leaderboard-table th, .leaderboard-table td {
  padding: 0.8rem 1rem;
  text-align: left;
  font-size: 0.95rem;
  color: var(--white);
}

.leaderboard-table th {
  font-weight: bold;
  text-transform: uppercase;
}

.leaderboard-table tr:nth-child(even) {
  background: #222;
}

.leaderboard-table tr:hover {
  background: rgba(254,100,28,0.15);
  transition: 0.2s;
}

.leaderboard-table tr.me {
  background: rgba(253,230,0,0.25);
  font-weight: bold;
}

.roster-panel {
  margin-top: 2rem;
  background: var(--purple);
  border-radius: 16px;
  padding: 1.5rem;
  max-height: var(--panel-max-height);
  overflow-y: auto;
  box-shadow: 0 0 15px rgba(0,0,0,0.4);
}

.roster-panel h2 {
  color: var(--orange);
  font-size: 1.6rem;
  margin-bottom: 1rem;
}

.roster-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 1rem;
}

.roster-card {
  background: var(--purple);
  border-radius: 12px;
  padding: 0.8rem;
  text-align: center;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
}

.roster-card img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 0.5rem;
}

.roster-card .name {
  font-size: 0.9rem;
  font-weight: bold;
  margin-bottom: 0.3rem;
  color: var(--orange);
}

.roster-card .club {
  font-size: 0.8rem;
  color: var(--orange);
}

.roster-card .points {
  font-size: 0.85rem;
  color: var(--orange);
  margin-bottom: 0.3rem;
}

a img {
  height: 50px;
  width: auto;
  display: block;
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: var(--yellow);
  animation: spin 1s ease-in-out infinite;
  margin-right: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.hidden {
  display: none;
}

.status-indicator {
  font-size: 0.8rem;
  color: var(--muted);
  margin-top: 10px;
  text-align: center;
}

.refresh-btn {
  background-color: var(--orange);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin-left: 10px;
}

.refresh-btn:hover {
  opacity: 0.9;
}
</style>
</head>
<body>
<header class="site-header">
  <div class="logo-container">
    <a href="dashboard.html"> <img src="image/logo.jpg" alt="logo"></a>
  </div>
</header>
<div class="leaderboard-page">
  <h1>LEADERBOARD</h1>
  <div style="text-align: center; margin-bottom: 1rem;">
    <span id="loading-indicator" class="loading"></span>
    <span id="status-text">Загрузка данных...</span>
    <button id="refresh-btn" class="refresh-btn hidden">Обновить</button>
  </div>
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th>TEAM</th>
        <th>TOUR 1</th>
        <th>TOUR 2-3</th>
        <th>TOUR 4</th>
        <th>TOUR 5</th>
        <th>1/8</th>
        <th>1/4</th>
        <th>1/2</th>
        <th>FINALS</th>
        <th>SUMMARY</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body">
      <tr><td colspan="10" style="text-align: center;">Загрузка данных...</td></tr>
    </tbody>
  </table>

  <div class="roster-panel hidden" id="roster-panel">
    <h2>TEAM ROSTER</h2>
    <div class="roster-list" id="roster-list"></div>
    <div id="team-history"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
const supabase = window.supabase.createClient(
  "https://xovxokupvsnnjtskdgvr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvdnhva3VwdnNubmp0c2tkZ3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDk4NjMsImV4cCI6MjA3MDQyNTg2M30.Vl5Z9DABFmHQWGtfbyuAZGGgfX4hDYGAPD8C7fr540E"
);

const TOURS = [
  {id: 1, name: "1"},
  {id: 2, name: "2-3", range: [2, 3]},
  {id: 4, name: "4"},
  {id: 5, name: "5"},
  {id: 6, name: "1/8"},
  {id: 7, name: "1/4"},
  {id: 8, name: "1/2"},
  {id: 99, name: "Финалы"}
];

// Элементы UI
const loadingIndicator = document.getElementById('loading-indicator');
const statusText = document.getElementById('status-text');
const refreshBtn = document.getElementById('refresh-btn');
const leaderboardBody = document.getElementById('leaderboard-body');

// Функция для получения кэшированных данных лидерборда
async function getCachedLeaderboard() {
  try {
    statusText.textContent = "Загрузка кэшированных данных...";
    
    const { data, error } = await supabase
      .from('leaderboard_cache')
      .select(`
        team_id,
        tour,
        points,
        user_teams!inner(team_name)
      `)
      .order('tour', { ascending: true });

    if (error) throw error;
    
    if (data && data.length > 0) {
      statusText.textContent = "Данные загружены из кэша";
      return data;
    } else {
      statusText.textContent = "Кэш пуст, требуется расчет...";
      return null;
    }
  } catch (error) {
    console.error('Ошибка получения кэшированных данных:', error);
    statusText.textContent = "Ошибка загрузки кэша";
    return null;
  }
}

// Функция для отображения лидерборда из кэша
function renderLeaderboardFromCache(cachedData) {
  // Группируем данные по командам
  const teamsData = {};
  cachedData.forEach(item => {
    if (!teamsData[item.team_id]) {
      teamsData[item.team_id] = {
        team_name: item.user_teams.team_name,
        points: {}
      };
    }
    teamsData[item.team_id].points[item.tour] = item.points;
  });
  
  // Очищаем таблицу
  leaderboardBody.innerHTML = '';
  
  // Заполняем таблицу данными
  Object.keys(teamsData).forEach(teamId => {
    const team = teamsData[teamId];
    const row = document.createElement('tr');
    
    // Название команды
    row.innerHTML = `<td>${team.team_name}</td>`;
    
    let totalSum = 0;
    
    // Добавляем ячейки для каждого тура
    TOURS.forEach(tour => {
      const tourId = tour.id;
      const points = team.points[tourId] || 0;
      totalSum += points;
      
      const cell = document.createElement('td');
      cell.innerHTML = `${points} <button class="show-lineup" data-team-id="${teamId}" data-tour="${tourId}">ROSTER</button>`;
      row.appendChild(cell);
    });
    
    // Итоговая сумма
    const totalCell = document.createElement('td');
    totalCell.textContent = totalSum;
    row.appendChild(totalCell);
    
    leaderboardBody.appendChild(row);
  });
  
  // Добавляем обработчики для кнопок
  document.querySelectorAll('.show-lineup').forEach(btn => {
    btn.addEventListener('click', async e => {
      const teamId = e.target.dataset.teamId;
      const tourId = parseInt(e.target.dataset.tour);
      await showRoster(teamId, tourId);
    });
  });
  
  // Показываем кнопку обновления
  refreshBtn.classList.remove('hidden');
  loadingIndicator.style.display = 'none';
}

// Функция для запуска расчета лидерборда в фоновом режиме
async function calculateLeaderboardBackground() {
  try {
    // Вызываем Edge Function для расчета лидерборда
    const { data, error } = await supabase.functions.invoke('calculate-leaderboard');
    
    if (error) {
      console.error('Ошибка вызова функции расчета:', error);
      statusText.textContent = "Ошибка расчета данных";
      return false;
    }
    
    return true;
  } catch (error) {
    console.error('Ошибка при вызове функции:', error);
    return false;
  }
}

// Функция для проверки актуальности кэша
async function checkCacheValidity() {
  try {
	const { data, error } = await supabase
	  .from('cache_metadata')
	  .select('last_updated')
	  .maybeSingle();


    if (error) return false;
    
    // Проверяем, когда кэш обновлялся в последний раз
    const lastUpdated = new Date(data.last_updated);
    const now = new Date();
    const diffHours = (now - lastUpdated) / (1000 * 60 * 60);
    
    // Если кэш старше 1 часа, считаем его устаревшим
    return diffHours < 1;
  } catch (error) {
    console.error('Ошибка проверки валидности кэша:', error);
    return false;
  }
}

// Основная функция загрузки лидерборда
async function loadLeaderboard() {
  // Показываем индикатор загрузки
  loadingIndicator.style.display = 'inline-block';
  statusText.textContent = "Проверка актуальности данных...";
  refreshBtn.classList.add('hidden');
  
  // Проверяем актуальность кэша
  const isCacheValid = await checkCacheValidity();
  
  if (isCacheValid) {
    // Загружаем данные из кэша
    const cachedData = await getCachedLeaderboard();
    
    if (cachedData) {
      renderLeaderboardFromCache(cachedData);
      return;
    }
  }
  
  // Если кэш не актуален или отсутствует
  statusText.textContent = "Обновление данных...";
  
  // Запускаем расчет в фоновом режиме
  const calculationStarted = await calculateLeaderboardBackground();
  
  if (calculationStarted) {
    statusText.textContent = "Данные обновляются в фоне...";
    
    // Показываем старые данные, если они есть
    const oldCachedData = await getCachedLeaderboard();
    if (oldCachedData) {
      renderLeaderboardFromCache(oldCachedData);
      statusText.textContent = "Используются предыдущие данные, обновление в процессе...";
    } else {
      leaderboardBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Расчет данных, пожалуйста подождите...</td></tr>';
    }
    
    // Периодически проверяем обновление кэша
    const checkInterval = setInterval(async () => {
      const isNowValid = await checkCacheValidity();
      
      if (isNowValid) {
        clearInterval(checkInterval);
        const newCachedData = await getCachedLeaderboard();
        if (newCachedData) {
          renderLeaderboardFromCache(newCachedData);
          statusText.textContent = "Данные обновлены!";
        }
      }
    }, 5000); // Проверяем каждые 5 секунд
  } else {
    statusText.textContent = "Не удалось запустить расчет";
    loadingIndicator.style.display = 'none';
  }
}

// Функция для отображения состава команды
async function showRoster(teamId, tourId) {
  try {
    const { data: rosterData, error } = await supabase
      .from('team_rosters_cache')
      .select(`
        player_id,
        points,
        players!inner(first_name, last_name, photo_url, country)
      `)
      .eq('team_id', teamId)
      .eq('tour_id', tourId);

    if (error) throw error;

    const rosterList = document.getElementById('roster-list');
    rosterList.innerHTML = '';

    if (rosterData && rosterData.length > 0) {
      rosterData.forEach(player => {
        const card = document.createElement('div');
        card.className = 'roster-card';
        card.innerHTML = `
          <img src="${player.players.photo_url || 'image/ball.svg'}" alt="">
          <div class="name">${player.players.first_name} ${player.players.last_name}</div>
          <div class="points">Очки: ${Math.round(player.points)}</div>
          <div class="club">${player.players.country}</div>
        `;
        rosterList.appendChild(card);
      });
    } else {
      rosterList.innerHTML = '<div>Состав не найден</div>';
    }

    document.getElementById('roster-panel').classList.remove('hidden');
  } catch (error) {
    console.error('Ошибка загрузки состава:', error);
  }
}

// Обработчик для кнопки обновления
refreshBtn.addEventListener('click', loadLeaderboard);

// Загружаем лидерборд при старте
document.addEventListener("DOMContentLoaded", loadLeaderboard);
</script>
</body>
</html>